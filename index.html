<script>
    // File upload handling
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('petImage').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    async function generateVideo() {
        const script = document.getElementById('scriptInput').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const fileInput = document.getElementById('fileInput');
        
        if (!script) {
            alert('Please enter what your pet should say!');
            return;
        }
        
        if (!apiKey) {
            alert('Please enter your Kie AI API key!');
            return;
        }
        
        if (!fileInput.files.length) {
            alert('Please upload a pet image!');
            return;
        }
        
        document.getElementById('loading').classList.add('active');
        document.getElementById('result').innerHTML = '';
        
        try {
            // Convert image to base64
            const imageBase64 = await fileToBase64(fileInput.files[0]);
            
            // Call API
            const response = await fetch('/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    script: script,
                    apiKey: apiKey,
                    imageBase64: imageBase64,
                    action: 'generate'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.data.videoUrl) {
                    showVideo(result.data.videoUrl);
                } else if (result.data.taskId) {
                    pollForVideo(result.data.taskId, apiKey);
                }
            } else {
                throw new Error(result.error || 'Generation failed');
            }
            
        } catch (error) {
            alert('Error: ' + error.message);
            document.getElementById('loading').classList.remove('active');
        }
    }

    async function pollForVideo(taskId, apiKey) {
        const maxAttempts = 60;
        for (let i = 0; i < maxAttempts; i++) {
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        taskId, 
                        apiKey,
                        action: 'status' 
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data.status === 'completed' && result.data.videoUrl) {
                    showVideo(result.data.videoUrl);
                    return;
                } else if (result.data && result.data.status === 'failed') {
                    throw new Error('Video generation failed');
                }
                
                await new Promise(resolve => setTimeout(resolve, 5000));
            } catch (error) {
                if (i === maxAttempts - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, 5000));
            }
        }
        throw new Error('Video generation timed out');
    }

    function showVideo(videoUrl) {
        document.getElementById('loading').classList.remove('active');
        document.getElementById('result').innerHTML = `
            <h3>ðŸŽ‰ Your Talking Pet is Ready!</h3>
            <video controls style="max-width: 100%; margin: 20px 0;">
                <source src="${videoUrl}" type="video/mp4">
            </video>
            <div>
                <button onclick="window.open('${videoUrl}', '_blank')">ðŸ“¥ Download Video</button>
            </div>
        `;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
</script>
